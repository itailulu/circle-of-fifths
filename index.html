<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Circle of Fifths</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --wheel-size: min(80vw, 500px);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            overflow: hidden;
            touch-action: none; /* Prevent scroll on mobile */
        }

        .app-wrapper {
            width: var(--wheel-size);
            height: var(--wheel-size);
            position: relative;
            cursor: grab;
            touch-action: none;
            border-radius: 50%;
            background: white;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            /* CRITICAL FIX: Clips the mask's outer shadow/edge to a perfect circle */
            overflow: hidden; 
            /* Fix for some browsers to respect border-radius clipping with transforms */
            -webkit-mask-image: -webkit-radial-gradient(white, black);
            mask-image: radial-gradient(white, black);
        }

        .wheel-container {
            width: 84%;
            height: 84%;
            position: absolute;
            top: 8%;
            left: 8%;
            border-radius: 50%;
            overflow: hidden;
            -webkit-mask-image: -webkit-radial-gradient(white, black);
            mask-image: radial-gradient(white, black);
        }

        .wheel-segment {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 70%; 
            height: 70%;
            transform-origin: 0% 0%;
            clip-path: polygon(0% 0%, 100% 0%, 100% 60%, 0% 0%); 
            display: block;
        }

        .key-text {
            position: absolute;
            transform-origin: center center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            white-space: nowrap;
            pointer-events: none;
            width: auto;
            height: auto;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        .wheel-mask {
            position: absolute;
            /* Expand slightly to ensure the edge bleeds into the overflow clip */
            top: -1px; left: -1px; right: -1px; bottom: -1px;
            width: calc(100% + 2px);
            height: calc(100% + 2px);
            pointer-events: none;
            z-index: 10;
            /* Shadow adds depth to windows, but outer shadow is now clipped by app-wrapper */
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.15));
        }

        .center-circle-container {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 20;
            pointer-events: none;
        }

        .center-circle {
            width: 30%; 
            height: 30%;
            border-radius: 50%;
            background-color: #1f2937;
            color: #ffffff;
            box-shadow: 0 0 25px rgba(0, 0, 0, 0.4);
            border: 6px solid #ffffff;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        
        .mask-label {
            font-family: 'Inter', sans-serif;
            font-weight: 900;
            fill: #94a3b8;
            font-size: 5px;
            pointer-events: none;
        }

        .controls {
            display: flex;
            gap: 20px;
            margin-top: 30px;
        }

        .control-btn {
            background-color: white;
            border: 1px solid #e5e7eb;
            color: #374151;
            padding: 12px 24px;
            border-radius: 9999px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .control-btn:hover {
            background-color: #f9fafb;
            transform: translateY(-1px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .control-btn:active {
            transform: translateY(0);
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06);
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4 select-none">

    <h1 class="text-3xl font-bold mb-4 text-gray-800">Circle of Fifths</h1>
    <p id="info-display" class="mb-6 text-lg font-medium text-gray-600 text-center h-16">
        Drag or click buttons to rotate
    </p>

    <div class="app-wrapper" id="app-wrapper">
        
        <div class="wheel-container" id="circle-wheel">
            <!-- Segments inserted via JS -->
        </div>

        <svg class="wheel-mask" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid meet" shape-rendering="geometricPrecision">
            <path d="M 50 50 L 86.06 13.93 A 51 51 0 0 1 86.06 86.06 Z" fill="white" />
            <path d="M 50 50 L 63.20 99.26 A 51 51 0 1 1 13.93 13.93 Z" fill="white" />
            
            <text x="50" y="7" text-anchor="middle" class="mask-label">I</text>
            <text x="27" y="12" text-anchor="middle" class="mask-label">IV</text>
            <text x="73" y="12" text-anchor="middle" class="mask-label">V</text>
            <text x="73" y="90" text-anchor="middle" class="mask-label">vii°</text>
        </svg>

        <div class="center-circle-container">
            <div class="center-circle">
                <span class="text-[10px] font-bold uppercase opacity-60 tracking-widest text-gray-400">Key</span>
                <span id="current-key-display" class="text-4xl font-black mt-0">C</span>
            </div>
        </div>

    </div>

    <!-- Rotation Controls -->
    <div class="controls">
        <button class="control-btn" onclick="stepRotate(-1)" title="Rotate Left (Sharp Direction)">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
            <span>Left</span>
        </button>
        <button class="control-btn" onclick="stepRotate(1)" title="Rotate Right (Flat Direction)">
            <span>Right</span>
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/></svg>
        </button>
    </div>

    <script>
        const circleData = [
            { major: 'C', minor: 'a minor', accidentals: '0', color: 'bg-red-600' },
            { major: 'G', minor: 'e minor', accidentals: '1#', color: 'bg-orange-500' },
            { major: 'D', minor: 'b minor', accidentals: '2#', color: 'bg-yellow-400' },
            { major: 'A', minor: 'f# minor', accidentals: '3#', color: 'bg-green-400' },
            { major: 'E', minor: 'c# minor', accidentals: '4#', color: 'bg-green-600' },
            { major: 'B / Cb', minor: 'g# / ab minor', accidentals: '5# / 7b', color: 'bg-teal-600' },
            { major: 'Gb / F#', minor: 'eb / d# minor', accidentals: '6b / 6#', color: 'bg-cyan-600' },
            { major: 'Db / C#', minor: 'bb / a# minor', accidentals: '5b / 7#', color: 'bg-blue-500' },
            { major: 'Ab', minor: 'f minor', accidentals: '4b', color: 'bg-indigo-600' },
            { major: 'Eb', minor: 'c minor', accidentals: '3b', color: 'bg-purple-600' },
            { major: 'Bb', minor: 'g minor', accidentals: '2b', color: 'bg-fuchsia-700' },
            { major: 'F', minor: 'd minor', accidentals: '1b', color: 'bg-pink-600' },
        ];
        
        const wheel = document.getElementById('circle-wheel');
        const wrapper = document.getElementById('app-wrapper');
        const infoDisplay = document.getElementById('info-display');
        const currentKeyDisplay = document.getElementById('current-key-display');
        
        const segmentCount = 12;
        const segmentAngle = 360 / segmentCount; 
        
        let currentRotation = -105; 
        let isDragging = false;
        let startAngle = 0;
        let center = { x: 0, y: 0 };
        
        function getCenterCoordinates() {
            const rect = wrapper.getBoundingClientRect();
            center.x = rect.left + rect.width / 2;
            center.y = rect.top + rect.height / 2;
        }

        function getAngle(x, y) {
            const dx = x - center.x;
            const dy = y - center.y;
            let angle = Math.atan2(dy, dx) * (180 / Math.PI);
            return (angle >= 0 ? angle : angle + 360);
        }

        function updateKeyDisplay() {
            let normalizedRot = currentRotation % 360;
            if (normalizedRot < 0) normalizedRot += 360;
            
            let targetLocalAngle = 270 - normalizedRot - 15;
            targetLocalAngle = (targetLocalAngle % 360 + 360) % 360;
            let index = Math.round(targetLocalAngle / 30) % 12;

            const key = circleData[index];
            currentKeyDisplay.textContent = key.major.split(' / ')[0]; 
            
            const getNeigh = (offset) => circleData[(index + offset + 12) % 12].major.split(' / ')[0];
            const left = getNeigh(-1); 
            const right = getNeigh(1); 
            const vii = getNeigh(5);   
            
            infoDisplay.innerHTML = `
                <div class="flex gap-6 justify-center items-center">
                   <div class="text-center"><div class="text-xs text-gray-400 font-bold mb-1">IV</div><div class="font-bold text-lg">${left}</div></div>
                   <div class="text-center scale-125 mx-2"><div class="text-xs text-gray-400 font-bold mb-1">I</div><div class="font-black text-2xl text-gray-800">${key.major.split(' / ')[0]}</div></div>
                   <div class="text-center"><div class="text-xs text-gray-400 font-bold mb-1">V</div><div class="font-bold text-lg">${right}</div></div>
                   <div class="text-center border-l-2 pl-6 border-gray-300"><div class="text-xs text-gray-400 font-bold mb-1">vii°</div><div class="font-bold text-lg text-gray-600">${vii}</div></div>
                </div>
            `;
        }

        function renderSegments() {
            const segmentsContainer = document.createDocumentFragment();

            circleData.forEach((key, index) => {
                const rotation = index * segmentAngle;
                
                const segment = document.createElement('div');
                segment.className = `wheel-segment ${key.color}`;
                segment.style.transform = `rotate(${rotation}deg)`;
                
                const sliceCenterAngleDeg = 15;
                const sliceCenterAngleRad = (sliceCenterAngleDeg * Math.PI) / 180;
                
                const textRadiusPercent = 55; 
                
                const left = textRadiusPercent * Math.cos(sliceCenterAngleRad);
                const top = textRadiusPercent * Math.sin(sliceCenterAngleRad);

                const textDiv = document.createElement('div');
                textDiv.className = 'key-text text-white';
                
                textDiv.style.left = `${left}%`;
                textDiv.style.top = `${top}%`;
                textDiv.style.transform = `translate(-50%, -50%) rotate(${sliceCenterAngleDeg + 90}deg)`;

                const majorSpan = document.createElement('div');
                majorSpan.className = 'text-xl sm:text-2xl font-black leading-tight text-center drop-shadow-md whitespace-nowrap';
                majorSpan.innerHTML = key.major.replace(' / ', '<span class="text-lg sm:text-xl opacity-90 mx-0.5">/</span>');

                const minorSpan = document.createElement('div');
                minorSpan.className = 'text-[10px] sm:text-xs font-bold opacity-90 mt-1 leading-tight text-center drop-shadow-sm';
                minorSpan.innerHTML = key.minor.replace(' minor', '').replace(' / ', '<br/>');

                textDiv.appendChild(majorSpan);
                textDiv.appendChild(minorSpan);
                
                segment.appendChild(textDiv);
                segmentsContainer.appendChild(segment);
            });
            
            wheel.appendChild(segmentsContainer);
        }

        function handleStart(clientX, clientY) {
            if (event.target.closest('.control-btn')) return; // Ignore drag if clicking buttons
            isDragging = true;
            wrapper.style.cursor = 'grabbing';
            getCenterCoordinates();
            startAngle = getAngle(clientX, clientY) - currentRotation;
            wheel.style.transition = 'none';
        }

        function handleMove(clientX, clientY) {
            if (!isDragging) return;
            const currentPointerAngle = getAngle(clientX, clientY);
            let newRotation = currentPointerAngle - startAngle;
            wheel.style.transform = `rotate(${newRotation}deg)`;
            currentRotation = newRotation;
            updateKeyDisplay();
        }

        function handleEnd() {
            if (!isDragging) return;
            isDragging = false;
            wrapper.style.cursor = 'grab';
            snapToGrid();
        }
        
        function snapToGrid() {
            const gridSize = 30;
            const offset = -15; 
            
            let shifted = currentRotation - offset;
            let snappedShifted = Math.round(shifted / gridSize) * gridSize;
            currentRotation = snappedShifted + offset;
            
            wheel.style.transition = 'transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
            wheel.style.transform = `rotate(${currentRotation}deg)`;
            
            updateKeyDisplay();
        }

        // Button Control Logic
        window.stepRotate = function(direction) {
            // Direction 1 = Clockwise (Right button)
            // Direction -1 = Counter-Clockwise (Left button)
            currentRotation += (direction * 30);
            
            wheel.style.transition = 'transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
            wheel.style.transform = `rotate(${currentRotation}deg)`;
            
            updateKeyDisplay();
        }

        wrapper.addEventListener('mousedown', (e) => handleStart(e.clientX, e.clientY));
        window.addEventListener('mousemove', (e) => handleMove(e.clientX, e.clientY));
        window.addEventListener('mouseup', handleEnd);

        wrapper.addEventListener('touchstart', (e) => {
            const touch = e.touches[0];
            handleStart(touch.clientX, touch.clientY);
        }, {passive: false});

        window.addEventListener('touchmove', (e) => {
            if(isDragging) {
                const touch = e.touches[0];
                handleMove(touch.clientX, touch.clientY);
            }
        }, {passive: false});

        window.addEventListener('touchend', handleEnd);
        window.addEventListener('resize', getCenterCoordinates);

        renderSegments();
        getCenterCoordinates();
        
        wheel.style.transform = `rotate(${currentRotation}deg)`;
        updateKeyDisplay();

    </script>
</body>
</html>
